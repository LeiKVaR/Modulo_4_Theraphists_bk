<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Gesti√≥n de Terapeutas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f7f7f7;
    }

    h1,
    h2 {
      text-align: center;
    }

    form {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }

    input,
    select,
    textarea,
    button {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 30px;
      background: white;
    }

    th,
    td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #f0f0f0;
    }

    .filters {
      max-width: 1000px;
      margin: auto;
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filters input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }

    .filters button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
      background-color: #007bff;
      color: white;
    }

    .filters button:hover {
      background-color: #0056b3;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    #editModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }

    #editModal .card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      min-width: 350px;
      max-width: 95vw;
      position: relative;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <h1>Registrar Terapeuta</h1>
  <form id="therapist-form" enctype="multipart/form-data">
    <div>
      <label>Tipo de Documento:</label>
      <select name="document_type" required>
        <option value="">Seleccione</option>
        <option value="DNI">DNI</option>
        <option value="Carnet de Extranjeria">Carn√© de Extranjer√≠a</option>
        <option value="Pasaporte">Pasaporte</option>
        <option value="Carne de Refugiado">Carn√© de Refugiado</option>
        <option value="PTP">PTP</option>
      </select>
    </div>
    <div>
      <label>Nro Documento:</label>
      <input type="text" name="document_number" required maxlength="20" />
    </div>
    <div>
      <label>Apellido Paterno:</label>
      <input type="text" name="last_name_paternal" required />
    </div>
    <div>
      <label>Apellido Materno:</label>
      <input type="text" name="last_name_maternal" />
    </div>
    <div>
      <label>Nombres:</label>
      <input type="text" name="first_name" required />
    </div>
    <div>
      <label>Fecha de Nacimiento:</label>
      <input type="date" name="birth_date" required />
    </div>
    <div>
      <label>Sexo:</label>
      <select name="gender" required>
        <option value="">Seleccione</option>
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
      </select>
    </div>
    <div>
      <label>Tel√©fono:</label>
      <input type="text" name="phone" required maxlength="15" />
    </div>
    <div>
      <label>Email:</label>
      <input type="email" name="email" required />
    </div>
    <div>
      <label>Ubicaci√≥n:</label>
      <input type="text" name="location" />
    </div>
    <div class="full-width">
      <label>Direcci√≥n:</label>
      <textarea name="address" required></textarea>
    </div>
    <div class="full-width">
      <label>Referencia Personal:</label>
      <input type="text" name="personal_reference" />
    </div>
    <div>
      <label>Activo:</label>
      <input type="checkbox" name="is_active" checked />
    </div>
    <div>
      <label>Foto de Perfil:</label>
      <input type="file" name="profile_picture" accept="image/*" />
    </div>
    <div class="full-width">
      <button type="submit">Registrar</button>
    </div>
  </form>

  <h2>Buscar Terapeutas</h2>
  <div class="filters">
    <input type="text" id="searchQuery" placeholder="Buscar por nombre, apellidos, documento, email..." />
  </div>

  <table id="therapist-table">
    <thead>
      <tr>
        <th>Documento</th>
        <th>Nombre</th>
        <th>Fecha Nac.</th>
        <th>Sexo</th>
        <th>Email</th>
        <th>Tel√©fono</th>
        <th>Ubicaci√≥n</th>
        <th>Activo</th>
        <th>Foto</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="editModal">
    <div class="card">
      <h2>Editar Terapeuta</h2>
      <form id="editForm" enctype="multipart/form-data">
        <input type="hidden" name="id" />
        <div>
          <label>Tipo de Documento:</label>
          <select name="document_type" required>
            <option value="">Seleccione</option>
            <option value="DNI">DNI</option>
            <option value="Carnet de Extranjeria">
              Carn√© de Extranjer√≠a
            </option>
            <option value="Pasaporte">Pasaporte</option>
            <option value="Carne de Refugiado">Carn√© de Refugiado</option>
            <option value="PTP">PTP</option>
          </select>
        </div>
        <div>
          <label>Nro Documento:</label>
          <input type="text" name="document_number" required maxlength="20" />
        </div>
        <div>
          <label>Apellido Paterno:</label>
          <input type="text" name="last_name_paternal" />
        </div>
        <div>
          <label>Apellido Materno:</label>
          <input type="text" name="last_name_maternal" />
        </div>
        <div>
          <label>Nombres:</label>
          <input type="text" name="first_name" required />
        </div>
        <div>
          <label>Fecha de Nacimiento:</label>
          <input type="date" name="birth_date" required />
        </div>
        <div>
          <label>Sexo:</label>
          <select name="gender" required>
            <option value="">Seleccione</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div>
          <label>Tel√©fono:</label>
          <input type="text" name="phone" required maxlength="15" />
        </div>
        <div>
          <label>Email:</label>
          <input type="email" name="email" required />
        </div>
        <div>
          <label>Ubicaci√≥n:</label>
          <input type="text" name="location" />
        </div>
        <div>
          <label>Direcci√≥n:</label>
          <textarea name="address" required></textarea>
        </div>
        <div>
          <label>Referencia Personal:</label>
          <input type="text" name="personal_reference" />
        </div>
        <div>
          <label>Activo:</label>
          <input type="checkbox" name="is_active" />
        </div>
        <div>
          <label>Foto de Perfil:</label>
          <input type="file" name="profile_picture" accept="image/*" />
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px">
          <button type="button" onclick="closeEditModal()">Cancelar</button>
          <button type="submit">Actualizar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="infoModal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      ">
    <div style="
          background: #222;
          color: #fff;
          padding: 30px;
          border-radius: 15px;
          min-width: 350px;
          max-width: 95vw;
          position: relative;
        ">
      <h2 style="text-align: center; margin-bottom: 10px">
        Informaci√≥n del Terapeuta
      </h2>
      <div id="infoContent"></div>
      <div style="margin-top: 20px; text-align: right">
        <button onclick="cerrarInfoModal()" style="
              background: #43b36a;
              color: #fff;
              padding: 8px 20px;
              border: none;
              border-radius: 5px;
            ">
          Cerrar
        </button>
      </div>
      <button onclick="cerrarInfoModal()" style="
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
          ">

      </button>
    </div>
  </div>

  <script>
    // Variables globales
    const apiUrl = "http://127.0.0.1:8000/api/therapists/";
    const form = document.getElementById("therapist-form");
    const tableBody = document.querySelector("#therapist-table tbody");
    const searchInput = document.getElementById("searchQuery");
    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editForm");
    let editingRow = null;
    let currentAbortController = null;

    // Constantes y helpers
    const DOC_MAX = {
      DNI: 9,
      "Carnet de Extranjeria": 12,
      Pasaporte: 9,
      "Carne de Refugiado": 10,
      PTP: 9,
    };
    const DOC_LENGTHS = {
      DNI: [8, 9],
      "Carnet de Extranjeria": [12],
      Pasaporte: [9],
      "Carne de Refugiado": [10],
      PTP: [9],
    };

    // Devuelve el HTML de una fila de terapeuta
    function rowHTML(t) {
      return `
        <td>${t.document_type ?? ""} ${t.document_number ?? ""}</td>
        <td>${t.first_name ?? ""} ${t.last_name_paternal ?? ""} ${t.last_name_maternal ?? ""
        }</td>
        <td>${t.birth_date ?? ""}</td>
        <td>${t.gender ?? ""}</td>
        <td>${t.email ?? ""}</td>
        <td>${t.phone ?? ""}</td>
        <td>${t.location ?? ""}</td>
        <td>${t.is_active ? "S√≠" : "No"}</td>
        <td>${t.profile_picture
          ? `<img src="${t.profile_picture}" alt="Foto" width="60"/>`
          : ""
        }</td>
        <td>
        <button onclick="editarTerapeuta('${t.id}',this)">Editar</button>
        <button onclick="eliminarTerapeuta('${t.id}',this)">Eliminar</button>
        <button onclick="mostrarInfo('${t.id}')">M√°s Info</button>
        </td>
    `;
    }
    // Crea FormData y normaliza campos especiales (checkbox)
    function buildFormData(formEl) {
      const fd = new FormData(formEl);
      if (formEl.is_active) fd.set("is_active", formEl.is_active.checked);
      return fd;
    }

    // Restringe a n√∫meros para los campos listados
    function addNumericFilter(formEl, fieldNames) {
      fieldNames.forEach((name) => {
        const f = formEl[name];
        if (!f) return;
        f.addEventListener("input", () => {
          f.value = f.value.replace(/\D/g, "");
        });
      });
    }

    // Ajusta maxLength del documento seg√∫n el tipo seleccionado
    function wireDocTypeMaxLength(formEl) {
      if (!formEl?.document_type || !formEl?.document_number) return;
      const apply = () => {
        const t = formEl.document_type.value;
        formEl.document_number.value = (
          formEl.document_number.value || ""
        ).replace(/\D/g, "");
        formEl.document_number.maxLength = DOC_MAX[t] || 20;
      };
      formEl.document_type.addEventListener("change", apply);
      apply();
    }

    // Validaciones comunes para formularios
    function validateCommon(formEl) {
      // Requeridos
      const requiredFields = formEl.querySelectorAll("[required]");
      for (let field of requiredFields) {
        if (!String(field.value || "").trim()) {
          Swal.fire({
            icon: "warning",
            title: "Campo obligatorio",
            text: "Por favor completa todos los campos obligatorios.",
          });
          field.focus();
          return false;
        }
      }

      // Documento por tipo
      const docType = formEl.document_type?.value;
      const docNumber = (formEl.document_number?.value || "").trim();
      if (docType && DOC_LENGTHS[docType]) {
        const allowed = DOC_LENGTHS[docType];
        if (!allowed.includes(docNumber.length)) {
          Swal.fire({
            icon: "error",
            title: "Documento inv√°lido",
            text: `El n√∫mero de documento debe tener ${allowed.join(
              " o "
            )} d√≠gitos para ${docType}.`,
          });
          formEl.document_number.focus();
          return false;
        }
      }

      // Nombres y apellidos
      const nameFields = [
        "first_name",
        "last_name_paternal",
        "last_name_maternal",
      ];
      for (let n of nameFields) {
        const v = (formEl[n]?.value || "").trim();
        if (v && !/^[A-Za-z√Å√â√ç√ì√ö√ë√°√©√≠√≥√∫√±0-9\s]+$/.test(v)) {
          Swal.fire({
            icon: "error",
            title: "Nombre inv√°lido",
            text: "Los nombres y apellidos solo deben contener letras y n√∫meros.",
          });
          formEl[n].focus();
          return false;
        }
      }

      // Tel√©fono
      const phone = (formEl.phone?.value || "").trim();
      if (!/^\d{1,15}$/.test(phone)) {
        Swal.fire({
          icon: "error",
          title: "Tel√©fono inv√°lido",
          text: "El tel√©fono debe tener solo n√∫meros, m√°ximo 15 d√≠gitos.",
        });
        formEl.phone.focus();
        return false;
      }

      // Email
      const email = (formEl.email?.value || "").trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        Swal.fire({
          icon: "error",
          title: "Correo inv√°lido",
          text: "Formato de correo inv√°lido.",
        });
        formEl.email.focus();
        return false;
      }
      return true;
    }

    // Para busqueda
    function throttle(fn, wait = 100) {
      let last = 0,
        timer;
      return (...args) => {
        const now = Date.now();
        const remaining = wait - (now - last);
        if (remaining <= 0) {
          last = now;
          fn.apply(null, args);
        } else {
          clearTimeout(timer);
          timer = setTimeout(() => {
            last = Date.now();
            fn.apply(null, args);
          }, remaining);
        }
      };
    }

    // Inicializaci√≥n
    window.onload = () => {
      cargar();

      // Reglas para formulario de registro
      addNumericFilter(form, ["document_number", "phone"]);
      wireDocTypeMaxLength(form);

      // Reglas para formulario de edici√≥n
      addNumericFilter(editForm, ["document_number", "phone"]);
      wireDocTypeMaxLength(editForm);
    };

    // B√∫squeda con throttle
    searchInput.addEventListener(
      "input",
      throttle(() => {
        cargar(searchInput.value.trim());
      }, 120)
    );

    // Carga y render
    function cargar(query = "") {
      if (currentAbortController) currentAbortController.abort();
      currentAbortController = new AbortController();
      let url = apiUrl;
      if (query) url += `?search=${encodeURIComponent(query)}`;
      renderLoading();
      fetch(url, { signal: currentAbortController.signal })
        .then((res) => res.json())
        .then((data) => renderRows(data))
        .catch((err) => {
          if (err.name !== "AbortError") {
            console.error(err);
            renderError();
          }
        });
    }

    // Renderiza todas las filas de la tabla
    function renderRows(data) {
      tableBody.innerHTML = "";
      if (!data || data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#777;">Sin resultados</td></tr>`;
        return;
      }
      data
        .slice()
        .reverse()
        .forEach((t) => agregarFila(t));
    }

    // Estados de carga / error
    function renderLoading() {
      tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#777;">Cargando...</td></tr>`;
    }

    function renderError() {
      tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#c00;">Error al cargar datos</td></tr>`;
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Error al cargar datos de terapeutas.",
      });
    }

    // Agrega una fila a la tabla al inicio
    function agregarFila(t, prepend = false) {
      const row = document.createElement("tr");
      row.innerHTML = rowHTML(t);
      if (prepend) tableBody.insertBefore(row, tableBody.firstChild);
      else tableBody.appendChild(row);
    }

    // Funcion de CRUD - Eliminar Terapeuta
    function eliminarTerapeuta(id, btn) {
      Swal.fire({
        title: "¬øSeguro que deseas eliminar este terapeuta?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "S√≠, eliminar",
        cancelButtonText: "Cancelar",
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(apiUrl + id + "/", { method: "DELETE" }).then((res) => {
            if (res.ok) {
              btn.closest("tr").remove();
              Swal.fire({
                icon: "success",
                title: "Eliminado",
                text: "El terapeuta ha sido eliminado correctamente.",
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "No se pudo eliminar el terapeuta.",
              });
            }
          });
        }
      });
    }

    // Modal para edicion
    function openEditModal(terapeuta, row) {
      editingRow = row;
      editModal.style.display = "flex";
      // Rellenar campos
      for (const key in terapeuta) {
        if (editForm[key] !== undefined) {
          if (editForm[key].type === "checkbox") {
            editForm[key].checked = !!terapeuta[key];
          } else {
            editForm[key].value = terapeuta[key] ?? "";
          }
        }
      }
      wireDocTypeMaxLength(editForm);
    }

    function closeEditModal() {
      editModal.style.display = "none";
      editForm.reset();
      editingRow = null;
    }

    // Funcion de Mostrar mas informacion del terapeuta
    function mostrarInfo(id) {
      fetch(apiUrl + id + "/")
        .then(res => res.json())
        .then(t => {
          const infoContent = document.getElementById("infoContent");
          infoContent.innerHTML = `
          <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
            <div style="background:#43b36a; border-radius:50%; width:70px; height:70px; display:flex; align-items:center; justify-content:center;">
              <span style="font-size:40px;">${t.profile_picture ? `<img src="${t.profile_picture}" alt="Foto" style="width:60px;height:60px;border-radius:50%;">` : "üë§"}</span>
            </div>
            <div>
              <div style="font-size:1.3em; font-weight:bold;">${t.first_name ?? ""} ${t.last_name_paternal ?? ""} ${t.last_name_maternal ?? ""}</div>
              <div style="font-size:1em; color:#b2ffb2;">Documento: ${t.document_number ?? ""}</div>
            </div>
          </div>
          <table style="width:100%; background:#222; border-radius:10px; padding:10px;">
            <tr><td>üìß</td><td>${t.email || "No registrado"}</td></tr>
            <tr><td>üìû</td><td>${t.phone || "No registrado"}</td></tr>
            <tr><td><b>Sexo</b></td><td>${t.gender || ""}</td></tr>
            <tr><td><b>Fecha de nacimiento</b></td><td>${t.birth_date || ""}</td></tr>
            <tr><td>üè†</td><td>${t.address || ""}</td></tr>
            <tr><td><b>Departamento</b></td><td>${t.department || ""}</td></tr>
            <tr><td><b>Provincia</b></td><td>${t.province || ""}</td></tr>
            <tr><td><b>Distrito</b></td><td>${t.district || ""}</td></tr>
            <tr><td><b>Referencia personal</b></td><td>${t.personal_reference || ""}</td></tr>
          </table>
        `;
          document.getElementById("infoModal").style.display = "flex";
        });
    }

    // Cerrar modal de informacion
    function cerrarInfoModal() {
      document.getElementById("infoModal").style.display = "none";
      document.getElementById("infoContent").innerHTML = "";
    }

    // Submit editar
    editForm.addEventListener("submit", function (e) {
      e.preventDefault();
      if (!validateCommon(editForm)) return;

      const id = editForm.id.value;
      const formData = buildFormData(editForm);

      fetch(apiUrl + id + "/", { method: "PUT", body: formData })
        .then((res) => {
          if (!res.ok) throw new Error("Error al actualizar");
          return res.json();
        })
        .then((terapeuta) => {
          if (editingRow) editingRow.innerHTML = rowHTML(terapeuta);
          closeEditModal();
          Swal.fire({
            icon: "success",
            title: "Actualizado",
            text: "El terapeuta ha sido actualizado correctamente.",
          });
        })
        .catch(() => {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "No se pudo actualizar el terapeuta.",
          });
        });
    });

    // Submit registrar
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      if (!validateCommon(form)) return;

      const formData = buildFormData(form);
      fetch(apiUrl, { method: "POST", body: formData })
        .then((res) => {
          if (!res.ok) throw new Error("Error al crear");
          return res.json();
        })
        .then((nuevo) => {
          agregarFila(nuevo, true);
          form.reset();
          Swal.fire({
            icon: "success",
            title: "Registrado",
            text: "El terapeuta ha sido registrado correctamente.",
          });
        })
        .catch(() => {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "No se pudo registrar el terapeuta.",
          });
        });
    });
    // Funcion de CRUD - Editar Terapeuta por ID
    function editarTerapeuta(id, btn) {
      fetch(apiUrl + id + "/")
        .then((res) => res.json())
        .then((terapeuta) => {
          openEditModal(terapeuta, btn.closest("tr"));
        });
    }
  </script>
</body>

</html>